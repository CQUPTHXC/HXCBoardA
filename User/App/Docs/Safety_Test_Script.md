# FOC安全系统测试脚本

## 测试命令序列

以下是通过串口发送的16进制命令，用于测试安全系统的各个功能。

### 1. 设置正常位置 (0.5 rad)
```
发送: AA 01 04 00 00 00 3F 55
说明: 设置目标位置为0.5弧度（约28.6度）
```

### 2. 设置超限位置 (5.0 rad)
```
发送: AA 01 04 00 00 A0 40 55
说明: 设置目标位置为5.0弧度，应触发位置超限保护
```

### 3. 紧急停止命令
```
发送: AA 10 00 55
说明: 立即触发紧急停止
```

### 4. 清除安全错误
```
发送: AA 11 00 55
说明: 手动清除安全错误，允许系统重启
```

### 5. 查询安全状态
```
发送: AA 13 00 55
说明: 查询当前安全状态，返回状态码
```

### 6. 设置正常速度 (10.0 rad/s)
```
发送: AA 02 04 00 00 20 41 55
说明: 设置目标速度为10.0 rad/s（如果在速度模式）
```

## 测试步骤

### 步骤1: 基本功能测试
1. 发送设置正常位置命令
2. 观察电机是否正常运动到目标位置
3. 发送查询安全状态命令，确认状态为0（正常）

### 步骤2: 位置保护测试
1. 发送设置超限位置命令
2. 观察是否在100ms内触发保护
3. 等待500ms关断时间 + 2000ms重启延时
4. 观察是否自动恢复

### 步骤3: 紧急停止测试
1. 发送设置正常位置命令，让电机开始运动
2. 发送紧急停止命令
3. 观察电机是否立即停止
4. 发送清除安全错误命令
5. 观察是否手动恢复正常

### 步骤4: 状态查询测试
1. 在各种状态下发送查询安全状态命令
2. 验证返回的状态码是否正确：
   - 0: 正常状态
   - 1: 速度超限
   - 2: 位置超限
   - 3: 电流超限
   - 4: 电压超限
   - 5: 紧急停止
   - 6: 恢复中

## 预期结果

### 正常情况
- 位置设置命令：电机平滑运动到目标位置
- 状态查询：返回状态码0
- 无异常报错或停机

### 保护触发
- 超限位置设置：电机停止运动，进入保护状态
- 等待关断时间后：状态变为恢复中(6)
- 等待重启延时后：自动恢复到正常状态(0)

### 紧急停止
- 紧急停止命令：电机立即停止，状态变为紧急停止(5)
- 清除错误命令：状态恢复到正常(0)，电机可重新运动

## 串口监控

建议在串口终端中监控以下信息：
```
Safety State: 0  (0=正常, 其他=故障类型)
Safety OK: YES  (YES=可运行, NO=被保护)
Emergency Stop Requested  (紧急停止提示)
Safety Error Cleared      (错误清除提示)
```

## 注意事项

1. **测试环境**: 确保电机可以安全转动，无机械阻挡
2. **监控方式**: 通过VOFA或串口终端观察状态信息
3. **保护时间**: 注意各种保护的时间参数，避免过早判断
4. **手动干预**: 如果自动测试异常，可随时发送紧急停止命令

## 故障排除

### 问题1: 命令无响应
- 检查串口连接和波特率
- 确认命令格式正确（包含帧头帧尾）
- 检查CRC校验是否正确

### 问题2: 保护不触发
- 检查安全参数设置是否正确
- 确认SafetyTask是否正常运行
- 检查电机实际状态是否达到保护阈值

### 问题3: 无法恢复
- 检查重启延时设置是否过长
- 确认ClearSafetyError函数是否被正确调用
- 检查系统是否有其他阻止重启的条件
